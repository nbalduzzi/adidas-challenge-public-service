<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Adidas_Logo.svg/1024px-Adidas_Logo.svg.png" width="320" alt="Nest Logo" /></a>
</p>

## Description

Adidas Challenge Public Service API

## Tech Stack

**NodeJS version:** v12.12.0

**Framework:** [NestJS](https://nestjs.com/)

**Documentation**: [Swagger](https://swagger.io/)

## Considerations

1. This API being public needs to create a token with the `secret` on `.env` file. This secret it's the same for all API's, this means that the `jwt` generated by a `secret` (stored by env files), in a real project must be signed on `RS256` algorithm with a `.pem` file (`public.pem` file in public api and `private.pem` file in all the secured API's left). I used a simple `HS256` algorithm for sign the jwt only for challenge purpose.

2. This API for each endpoint request will call a middleware that will autogenerate a signed token with the `secret` stored in `.env` file. Is not the best solution, but this was only for challenge purpose.

3. On `consent` is `true` the subscription service will send the email notification. In other way the `emailNotificationStatus` always be `PENDING`

4. The `.env.production` file is in the repository and the information inside is the same as `.env.development` for challenge purpose, but this must not be like this. The production enviroment variables must be in some `vpc` or some secured storage and encrypted, and must be injected (or replaced) on deploy step.
The `SECRET` inside must be different of `development env` and the `SUBSCRIPTION_SERVICE_URL` should point to the production url

### Helmet and Cors

1. `Cors` was enabled for challenge purpose. Is not fully configurated for special origins.

2. `Helmet` used for helping setting various HTTP headers for security reasons.

### Validation Input Data

Validation pipe added for validate controllers DTO's structure.

## Requirements

1. [NodeJS](https://nodejs.org/es/download/) installed

2. [NVM](https://github.com/nvm-sh/nvm) installed

## Installation

```bash
# Set the node version on .nvmrc file
$ nvm use

# Install dependencies
$ npm install
```

## Running the app

```bash
# development
$ npm run start # run on port 3000

# watch mode
$ npm run start:dev # run on port 3000

# production mode
$ npm run start:prod # run on port 3000
```

> Healt Check enpoint on `http://localhost:3000/ping`

## Test

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

> **Note:** Only run e2e test on `/ping` (health check) endpoint

## Docker

```bash
# Docker build image
$ docker build . -t adidas-challenge-public-service

# Docker run image
$ docker run -p3000:3000 adidas-challenge-public-service
```

### Docker Compose

```bash
# Up containers
$ docker-compose up

# Clean and up containers
$ docker-compose up --build --force-recreate
```

## Documentation

Swagger documentation only on dev instance: `http:localhost:3000/api`

## CI/CD Proposal

This pipeline executes on push to any branch

| Step Name | Description | Trigger | Tasks |
|---|---|---|---|
| Build | Build image | `Automatic` *(On `branch push`)* | Build Docker image |
| Test | Testing and security | `Automatic` *(On `build step success`)* | `Parallel` | On `Build` step |
|---|---|---| `npm audit dependecies` |
|---|---|---| `unit test` |
| Deploy `Dev` | Deploy builded image to `Dev` environment | `Automatic` *(On `test step success`)* | Execute command to deploy to `development` environment |
| Test `e2e` | Check Overall API endpoints on `dev` | `Manual` *(On `deploy dev` step success)* | Execute `e2e` tests |
| Deploy `Staging` | Deploy builded image to `Staging` environment | `Manual` *(On `deploy dev` step success)* | `Replace` or `inject` the `env values` and execute command to deploy to `staging` environment |
| Deploy `Production` | Deploy builded image to `Production` environment | `Manual` *(On `deploy dev` step success)* | `Replace` or `inject` the `env values` and execute command to deploy to `production` environment |

## Kubernetes

The `kubernetes` configuration is in `k8s` folder inside the project.

As a Backend Developer, only create the `yml` files for: `secrets`, `config maps` and `deployment`.

## License

[MIT licensed](LICENSE).
